language: python
python:
  - "3.5"
  - "3.6"

env:
  - "MPI=mpich"
  - "MPI=openmpi"

os: linux
dist: trusty
sudo: required

git:
  depth: false

cache:
  pip: true
  apt: true
  directories:
    - .cache

branches:
  only:
    - master
    - develop
    - test

before_install:
  - ./conf/install-blas.sh
  - ./conf/install-mpi.sh $MPI
  - python -m pip install cython
  - python --version
  - python -c "import numpy;print(numpy.__version__)"
  # Build scipy from source
  - git clone https://github.com/scipy/scipy.git .cache/scipy
  - travis_wait 50 python -m pip install -q .cache/scipy
  - if [[ "$MPI" == "mpich"   ]]; then mpichversion; fi
  - if [[ "$MPI" == "openmpi" ]]; then ompi_info;    fi

install:
  - python -m pip install -q .[mpi]

before_script:
  - if [[ "$MPI" == "mpich" ]]; then P=2; else P=5; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]];  then P=2; fi

script:
  - ./conf/environment.sh
  # Test without MPI
  - python setup.py test
  # Test with MPI
  - mpiexec -n $P python run_mpi_test.py
